<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Tập Cộng Nhẩm - Lớp 4A</title>
    <link rel="icon" href="https://img.icons8.com/color/48/calculator.png">
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #334155; padding-top: 80px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Header dính */
        .sticky-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 10px 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-weight: bold; font-size: 1.2rem; color: var(--primary); margin: 0; }
        .timer-badge { background:#fff1f2; color:#be123c; padding:8px 15px; border-radius:20px; font-weight:bold; border:1px solid #fda4af; }

        .student-info-area { text-align: center; margin-bottom: 30px; }
        
        /* Select Box chọn tên */
        .student-select { 
            padding: 12px 25px; border-radius: 50px; border: 2px solid #cbd5e1; 
            width: 80%; max-width: 400px; font-size: 1.1rem; outline: none; 
            background: white; cursor: pointer; color: #334155; font-weight: 600;
        }
        .student-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }

        /* Khu vực bài làm */
        .hidden { display: none !important; }
        .exercise-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 6px solid #0ea5e9; }
        .exercise-title { font-weight: bold; font-size: 1.2rem; color: var(--primary); margin-bottom: 15px; }
        .sequence-container { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .num-box { width: 45px; height: 45px; border: 2px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; background-color: #f1f5f9; }
        input.num-input { width: 45px; height: 45px; border: 2px solid #cbd5e1; border-radius: 8px; text-align: center; font-size: 1rem; font-weight: bold; }
        
        .btn-action { background-color: var(--primary); color: white; border: none; padding: 15px 50px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; display: block; margin: 40px auto; width: 100%; max-width: 300px; transition: 0.3s; }
        .btn-start { background-color: #22c55e; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); animation: pulse 2s infinite; }
        .btn-submit:disabled { background-color: #94a3b8; cursor: not-allowed; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* Popup kết quả */
        #result-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .result-modal { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: #f0f9ff; border: 5px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: var(--primary); margin: 0 auto 20px auto; }
        .grade-badge { display: inline-block; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: white; margin-bottom: 20px; }
        .correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 600px) { .num-box, input.num-input { width: 35px; height: 35px; font-size: 0.9rem; } .container { padding-bottom: 100px; } }
    </style>
</head>
<body>

<div class="sticky-header">
    <h3 class="app-title">Lớp 4A - Thầy Tuyến</h3>
    <div class="timer-badge">⏱ <span id="timerDisplay">00:00</span></div>
</div>

<div class="container">
    <div class="student-info-area">
        <h1 style="color: var(--primary); margin-bottom: 5px;">LUYỆN CỘNG NHẨM</h1>
        <p style="color: #64748b; margin-top:0; margin-bottom: 20px;">Điền số thích hợp vào chỗ trống</p>
        
        <select id="studentName" class="student-select">
            <option value="">-- Chọn tên của em --</option>
        </select>
    </div>

    <button id="startBtn" class="btn-action btn-start" onclick="startExam()">BẮT ĐẦU LÀM BÀI</button>

    <div id="examArea" class="hidden">
        <div id="exercises-container"></div>
        <button type="button" class="btn-action btn-submit" id="submitBtn" onclick="submitQuiz()">
            <div class="loader" id="btnLoader"></div>
            <span id="btnText">NỘP BÀI</span>
        </button>
    </div>
</div>

<div id="result-overlay">
    <div class="result-modal">
        <div class="score-circle" id="finalScore">0/0</div>
        <h2 id="finalGrade" style="margin: 5px 0;"></h2>
        <div id="finalGradeBadge" class="grade-badge"></div>
        <div style="margin-bottom: 10px;">Thời gian: <strong id="finalTime" style="color: #be123c;">00:00</strong></div>
        <div id="db-status" style="margin-top:10px; font-size: 0.9rem;"></div>
        <button onclick="document.getElementById('result-overlay').style.display='none'" style="margin-top:20px; padding:10px 30px; border-radius:25px; border:none; background:#cbd5e1; cursor:pointer; font-weight:bold; color:#334155;">Xem lại bài</button>
        <button onclick="location.reload()" style="margin-top:10px; margin-left: 10px; padding:10px 30px; border-radius:25px; border:none; background:#22c55e; color:white; cursor:pointer; font-weight:bold;">Làm bài mới</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA77lLi_JCLIdR535KEfg3S0_Ge2EorPMo",
        authDomain: "baikiemtracuoiki.firebaseapp.com",
        projectId: "baikiemtracuoiki",
        storageBucket: "baikiemtracuoiki.firebasestorage.app",
        messagingSenderId: "953819948776",
        appId: "1:953819948776:web:4e9a017a6c5fc10ed28b5d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const DANH_SACH_LOP = [
        "Vũ Việt Anh", "Vũ Gia Bảo", "Lê Thị Liên Chi", "Bùi Anh Dũng", "Vũ Quốc Duy",
        "Nguyễn Đăng Dương", "Nguyễn Trí Đại", "Lê Bá Đạt", "Nguyễn Văn Đạt", "Lê Minh Hạnh",
        "Vũ Ngọc Huyền", "Lê Gia Khánh", "Nguyễn Đăng Kiên", "Vũ Đình Khánh Linh", "Mai Quang Long",
        "Lê Văn Lộc", "Vũ Anh Minh", "Hoàng Bảo Nam", "Phạm Thị Kim Ngân", "Vũ Thu Ngân",
        "Vũ Thị Yến Nhi", "Đàm Thị Quỳnh Như", "Phạm Hạnh Gia Phát", "Nguyễn Hoàng Thiên Phúc", "Vũ Quang Phúc",
        "Nguyễn Nhã Phương", "Nguyễn Thị Quỳnh", "Lê Ngọc Sơn", "Đặng Thị Thanh Tâm", "Vũ Thị Minh Tâm",
        "Lê Vũ Chí Thành", "Lê Anh Thơ", "Vũ Song Vũ"
    ];

    // Khởi tạo danh sách khi tải trang
    const selectBox = document.getElementById('studentName');
    if(selectBox) {
        DANH_SACH_LOP.forEach(ten => {
            const option = document.createElement('option');
            option.value = ten;
            option.text = ten;
            selectBox.appendChild(option);
        });
    }

    const exercisesData = [
        { id: 1, step: 2, start: [21, 23], title: "Bài 1: Cộng thêm 2" },
        { id: 2, step: 3, start: [12, 15], title: "Bài 2: Cộng thêm 3" },
        { id: 3, step: 4, start: [14, 18], title: "Bài 3: Cộng thêm 4" },
        { id: 4, step: 5, start: [15, 20], title: "Bài 4: Cộng thêm 5" },
        { id: 5, step: 6, start: [13, 19], title: "Bài 5: Cộng thêm 6" },
        { id: 6, step: 7, start: [11, 18], title: "Bài 6: Cộng thêm 7" },
        { id: 7, step: 8, start: [15, 23], title: "Bài 7: Cộng thêm 8" },
        { id: 8, step: 9, start: [12, 21], title: "Bài 8: Cộng thêm 9 (Dạng 1)" },
        { id: 9, step: 9, start: [19, 28], title: "Bài 9: Cộng thêm 9 (Dạng 2)" }
    ];

    const TOTAL_BLANKS_PER_EXERCISE = 18;
    let timerInterval;
    let secondsElapsed = 0;
    let isSubmitting = false;

    // Render bài tập ngay từ đầu nhưng để ẩn
    function renderExercises() {
        const container = document.getElementById('exercises-container');
        if(!container) return;
        
        let html = '';
        exercisesData.forEach((ex) => {
            let inputs = '';
            for(let i=0; i<TOTAL_BLANKS_PER_EXERCISE; i++) inputs += `<input type="number" class="num-input" id="ex-${ex.id}-in-${i}" placeholder="?">`;
            
            html += `
                <div class="exercise-card">
                    <div class="exercise-title"><span>${ex.title}</span></div>
                    <div class="sequence-container">
                        <div class="num-box">${ex.start[0]}</div>
                        <div class="num-box">${ex.start[1]}</div>
                        ${inputs}
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }

    // Bắt đầu làm bài
    window.startExam = function() {
        const name = document.getElementById('studentName').value;
        if (!name) { alert("Em chưa chọn tên! Hãy chọn tên trong danh sách nhé."); return; }

        document.getElementById('startBtn').classList.add('hidden'); // Ẩn nút bắt đầu
        document.getElementById('examArea').classList.remove('hidden'); // Hiện bài thi
        document.getElementById('studentName').disabled = true; // Khóa tên

        // Bắt đầu đếm giờ
        timerInterval = setInterval(() => {
            secondsElapsed++;
            const m = Math.floor(secondsElapsed / 60);
            const s = secondsElapsed % 60;
            document.getElementById('timerDisplay').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }, 1000);
    };

    function stopTimer() { clearInterval(timerInterval); }

    async function submitQuiz() {
        if (isSubmitting) return;
        const name = document.getElementById('studentName').value;

        isSubmitting = true;
        stopTimer();
        
        const btn = document.getElementById('submitBtn');
        const loader = document.getElementById('btnLoader');
        const btnText = document.getElementById('btnText');
        const finalTimeString = document.getElementById('timerDisplay').innerText;
        
        btn.disabled = true;
        loader.style.display = 'inline-block';
        btnText.innerText = 'ĐANG CHẤM...';

        let totalCorrect = 0;
        let totalQuestions = exercisesData.length * TOTAL_BLANKS_PER_EXERCISE;
        let details = [];

        exercisesData.forEach(ex => {
            let currentVal = ex.start[1];
            let exerciseCorrectCount = 0;
            for (let i = 0; i < TOTAL_BLANKS_PER_EXERCISE; i++) {
                currentVal = currentVal + ex.step;
                const inputEl = document.getElementById(`ex-${ex.id}-in-${i}`);
                if(inputEl) {
                    const studentVal = parseInt(inputEl.value);
                    inputEl.disabled = true;
                    if (studentVal === currentVal) {
                        totalCorrect++;
                        exerciseCorrectCount++;
                        inputEl.classList.add('correct');
                    } else {
                        inputEl.classList.add('incorrect');
                    }
                }
            }
            details.push({ bai: ex.id, dung: exerciseCorrectCount });
        });

        const percentage = (totalCorrect / totalQuestions) * 100;
        let gradeText = "", gradeColor = "";
        if (percentage >= 90) { gradeText = "Xuất Sắc!"; gradeColor = "#22c55e"; }
        else if (percentage >= 75) { gradeText = "Giỏi Quá!"; gradeColor = "#3b82f6"; }
        else if (percentage >= 50) { gradeText = "Khá Tốt!"; gradeColor = "#eab308"; }
        else { gradeText = "Cần Cố Gắng!"; gradeColor = "#ef4444"; }

        document.getElementById('finalScore').innerText = `${totalCorrect}/${totalQuestions}`;
        document.getElementById('finalTime').innerText = finalTimeString;
        document.getElementById('finalGrade').innerText = gradeText;
        document.getElementById('finalGradeBadge').style.backgroundColor = gradeColor;
        document.getElementById('finalGradeBadge').innerText = `${Math.round(percentage)}%`;
        document.getElementById('result-overlay').style.display = 'flex';

        const statusDiv = document.getElementById('db-status');
        if (db) {
            try {
                await addDoc(collection(db, "on_tap_cong_nham"), {
                    ten_hoc_sinh: name, 
                    diem_so: totalCorrect,
                    tong_so_o: totalQuestions,
                    thoi_gian_lam_bai: finalTimeString,
                    thoi_gian_giay: secondsElapsed,
                    xep_loai: gradeText,
                    ngay_nop: serverTimestamp(),
                    chi_tiet: details
                });
                statusDiv.innerHTML = "<span style='color:green; font-weight:bold'>✔ Đã lưu kết quả thành công!</span>";
                btnText.innerText = "ĐÃ NỘP XONG";
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = "<span style='color:red'>Lỗi gửi bài.</span>";
                isSubmitting = false;
                btn.disabled = false;
                btnText.innerText = "THỬ NỘP LẠI";
            }
        }
        loader.style.display = 'none';
    }

    window.submitQuiz = submitQuiz;
    renderExercises(); // Chạy tạo câu hỏi ngay khi tải trang
</script>

</body>
</html>
