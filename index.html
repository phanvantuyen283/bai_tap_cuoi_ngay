<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în T·∫≠p C√¢u 4 Th√†nh Ph·∫ßn - L·ªõp 4A</title>
    <link rel="icon" href="https://img.icons8.com/color/48/book.png">
    <style>
        :root { --primary: #ea580c; --secondary: #fb923c; --success: #22c55e; --error: #ef4444; --bg: #fff7ed; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #431407; padding-top: 80px; }
        .container { max-width: 800px; margin: 0 auto; }
        .sticky-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 10px 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-weight: bold; font-size: 1.1rem; color: var(--primary); margin: 0; text-transform: uppercase; }
        
        /* Dropdown ch·ªçn t√™n */
        .student-select { 
            padding: 12px 25px; border-radius: 50px; border: 2px solid #fdba74; 
            width: 80%; max-width: 400px; font-size: 1.1rem; outline: none; 
            background: white; cursor: pointer; color: #ea580c; font-weight: 600; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ea580c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 20px;
        }
        .student-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.2); }

        .student-info { margin-bottom: 20px; text-align: center; }
        .question-card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .question-number { font-weight: 800; color: var(--primary); margin-bottom: 10px; display: block; font-size: 0.9rem; text-transform: uppercase; }
        .question-text { font-size: 1.15rem; margin-bottom: 20px; font-weight: 600; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 2px solid #fed7aa; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .option-label:hover { background-color: #fff7ed; border-color: var(--primary); }
        input[type="radio"] { margin-right: 15px; width: 18px; height: 18px; accent-color: var(--primary); }
        .option-label.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #14532d !important; }
        .option-label.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; }
        .explanation { margin-top: 20px; padding: 15px; background-color: #eff6ff; border-radius: 8px; display: none; font-size: 0.95rem; color: #1e40af; }
        .btn-submit { background: linear-gradient(135deg, #ea580c, #c2410c); color: white; border: none; padding: 15px 50px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; display: block; margin: 40px auto; width: 100%; max-width: 300px; }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; }
        #result-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .result-modal { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: #fff7ed; border: 5px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: var(--primary); margin: 0 auto 20px auto; }
        .grade-badge { display: inline-block; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: white; margin-bottom: 20px; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 600px) { .question-text { font-size: 1rem; } body { padding-top: 70px; } }
    </style>
</head>
<body>

<div class="sticky-header">
    <h3 class="app-title">L·ªõp 4A - Th·∫ßy Tuy·∫øn</h3>
    <div style="background:#fff1f2; color:#be123c; padding:8px 15px; border-radius:20px; font-weight:bold; border:1px solid #fda4af;">‚è± <span id="timerDisplay">00:00</span></div>
</div>

<div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: var(--primary); margin-bottom: 5px;">√îN T·∫¨P TI·∫æNG VI·ªÜT</h1>
        <p style="color: #9a3412; margin-top: 0; margin-bottom: 20px;">C√¢u 4 th√†nh ph·∫ßn: Th·ªùi gian - ƒê·ªãa ƒëi·ªÉm - Ch·ªß ng·ªØ - Ho·∫°t ƒë·ªông</p>
        
        <select id="studentName" class="student-select">
            <option value="">-- Ch·ªçn t√™n c·ªßa em --</option>
        </select>
    </div>

    <form id="quizForm">
        <div id="questions-container"></div>
        <button type="button" class="btn-submit" id="submitBtn" onclick="window.submitQuiz()">
            <div class="loader" id="btnLoader"></div>
            <span id="btnText">N·ªòP B√ÄI</span>
        </button>
    </form>
</div>

<div id="result-overlay">
    <div class="result-modal">
        <div class="score-circle" id="finalScore">0/0</div>
        <h2 id="finalGrade" style="margin: 5px 0;"></h2>
        <div id="finalGradeBadge" class="grade-badge"></div>
        <div style="font-size: 1.1rem; margin-bottom: 10px;">Th·ªùi gian: <strong id="timeResult" style="color:#b91c1c"></strong></div>
        <div style="margin-top:10px; font-size: 0.9rem;" id="db-status"></div>
        <div style="margin-top:20px;">
            <button onclick="document.getElementById('result-overlay').style.display='none'" style="padding: 10px 30px; border-radius: 20px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; font-weight: bold; color: #444;">Xem l·∫°i b√†i</button>
            <button onclick="location.reload()" style="padding: 10px 30px; border-radius: 20px; border: none; background: #22c55e; color: white; cursor: pointer; font-weight: bold; margin-left: 10px;">L√†m b√†i m·ªõi</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA77lLi_JCLIdR535KEfg3S0_Ge2EorPMo",
        authDomain: "baikiemtracuoiki.firebaseapp.com",
        projectId: "baikiemtracuoiki",
        storageBucket: "baikiemtracuoiki.firebasestorage.app",
        messagingSenderId: "953819948776",
        appId: "1:953819948776:web:4e9a017a6c5fc10ed28b5d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DANH S√ÅCH L·ªöP 4A CHU·∫®N X√ÅC
    const DANH_SACH_LOP = [
        "V≈© Vi·ªát Anh", "V≈© Gia B·∫£o", "L√™ Th·ªã Li√™n Chi", "B√πi Anh D≈©ng", "V≈© Qu·ªëc Duy",
        "Nguy·ªÖn ƒêƒÉng D∆∞∆°ng", "Nguy·ªÖn Tr√≠ ƒê·∫°i", "L√™ B√° ƒê·∫°t", "Nguy·ªÖn VƒÉn ƒê·∫°t", "L√™ Minh H·∫°nh",
        "V≈© Ng·ªçc Huy·ªÅn", "L√™ Gia Kh√°nh", "Nguy·ªÖn ƒêƒÉng Ki√™n", "V≈© ƒê√¨nh Kh√°nh Linh", "Mai Quang Long",
        "L√™ VƒÉn L·ªôc", "V≈© Anh Minh", "Ho√†ng B·∫£o Nam", "Ph·∫°m Th·ªã Kim Ng√¢n", "V≈© Thu Ng√¢n",
        "V≈© Th·ªã Y·∫øn Nhi", "ƒê√†m Th·ªã Qu·ª≥nh Nh∆∞", "Ph·∫°m H·∫°nh Gia Ph√°t", "Nguy·ªÖn Ho√†ng Thi√™n Ph√∫c", "V≈© Quang Ph√∫c",
        "Nguy·ªÖn Nh√£ Ph∆∞∆°ng", "Nguy·ªÖn Th·ªã Qu·ª≥nh", "L√™ Ng·ªçc S∆°n", "ƒê·∫∑ng Th·ªã Thanh T√¢m", "V≈© Th·ªã Minh T√¢m",
        "L√™ V≈© Ch√≠ Th√†nh", "L√™ Anh Th∆°", "V≈© Song V≈©"
    ];

    // N·∫°p danh s√°ch v√†o Select Box
    const selectBox = document.getElementById('studentName');
    DANH_SACH_LOP.forEach(ten => {
        const option = document.createElement('option');
        option.value = ten;
        option.text = ten;
        selectBox.appendChild(option);
    });

    // D·ªÆ LI·ªÜU C√ÇU H·ªéI
    const questions = [
        { id: 1, text: "C√¢u n√†o d∆∞·ªõi ƒë√¢y tu√¢n th·ªß ƒë√∫ng c·∫•u tr√∫c: Th·ªùi gian + ƒê·ªãa ƒëi·ªÉm + Ch·ªß ng·ªØ + Ho·∫°t ƒë·ªông?", options: ["S√°ng nay, m·∫π em ƒëi ch·ª£ t·∫°i si√™u th·ªã.", "·ªû s√¢n tr∆∞·ªùng, s√°ng th·ª© hai, ch√∫ng em ch√†o c·ªù.", "S√°ng th·ª© hai, ·ªü s√¢n tr∆∞·ªùng, ch√∫ng em ch√†o c·ªù.", "Ch√∫ng em ch√†o c·ªù s√°ng th·ª© hai ·ªü s√¢n tr∆∞·ªùng."], correct: 2, explain: "ƒê√°p √°n ƒë√∫ng l√† C: S√°ng th·ª© hai (TG) + ·ªü s√¢n tr∆∞·ªùng (ƒêƒê) + ch√∫ng em (CN) + ch√†o c·ªù (Hƒê)." },
        { id: 2, text: "Trong c√°c c√¢u sau, c√¢u n√†o vi·∫øt ƒë√∫ng theo c√¥ng th·ª©c ƒë√£ h·ªçc?", options: ["H√¥m qua, tr√™n c√†nh c√¢y, ch√∫ chim h√≥t l√≠u lo.", "Ch√∫ chim h√≥t l√≠u lo tr√™n c√†nh c√¢y h√¥m qua.", "Tr√™n c√†nh c√¢y, h√¥m qua, ch√∫ chim h√≥t l√≠u lo.", "H√¥m qua, ch√∫ chim h√≥t l√≠u lo tr√™n c√†nh c√¢y."], correct: 0, explain: "ƒê√°p √°n ƒë√∫ng l√† A." },
        { id: 3, text: "X√°c ƒë·ªãnh c√¢u ƒë√∫ng c·∫•u tr√∫c: Th·ªùi gian + ƒê·ªãa ƒëi·ªÉm + Ch·ªß ng·ªØ + Ho·∫°t ƒë·ªông.", options: ["M√πa h√®, ve k√™u r√¢m ran trong v√≤m l√°.", "Trong v√≤m l√°, m√πa h√®, ve k√™u r√¢m ran.", "M√πa h√®, trong v√≤m l√°, ve k√™u r√¢m ran.", "Ve k√™u r√¢m ran trong v√≤m l√° v√†o m√πa h√®."], correct: 2, explain: "ƒê√°p √°n ƒë√∫ng l√† C." },
        { id: 4, text: "ƒêi·ªÅn t·ª´ ch·ªâ TH·ªúI GIAN: \"....., tr√™n c√°nh ƒë·ªìng, c√°c b√°c n√¥ng d√¢n ƒëang g·∫∑t l√∫a.\"", options: ["·ªû nh√†", "ChƒÉm ch·ªâ", "Bu·ªïi s√°ng", "Con tr√¢u"], correct: 2, explain: "\"Bu·ªïi s√°ng\" l√† t·ª´ ch·ªâ th·ªùi gian." },
        { id: 5, text: "Ch·ªçn t·ª´ ch·ªâ TH·ªúI GIAN: \"....., t·∫°i ph√≤ng kh√°ch, c·∫£ nh√† em qu√¢y qu·∫ßn xem tivi.\"", options: ["T·ªëi h√¥m qua", "Tr√™n gh·∫ø sofa", "Vui v·∫ª", "B·ªë m·∫π"], correct: 0, explain: "\"T·ªëi h√¥m qua\" l√† th·ªùi gian ph√π h·ª£p." },
        { id: 6, text: "ƒêi·ªÅn t·ª´ ch·ªâ TH·ªúI GIAN: \"....., d∆∞·ªõi s√¢n tr∆∞·ªùng, h·ªçc sinh n√¥ ƒë√πa vui v·∫ª.\"", options: ["Gi·ªù ra ch∆°i", "L·ªõp h·ªçc", "Quy·ªÉn s√°ch", "Nhanh nh·∫πn"], correct: 0, explain: "\"Gi·ªù ra ch∆°i\" l√† m·ªëc th·ªùi gian." },
        { id: 7, text: "Ch·ªçn t·ª´ ch·ªâ ƒê·ªäA ƒêI·ªÇM: \"S√°ng ch·ªß nh·∫≠t, ....., m·∫π d·∫Øt em ƒëi mua s√°ch.\"", options: ["v√†o l√∫c 8 gi·ªù", "t·∫°i nh√† s√°ch", "chi·∫øc xe ƒë·∫°p", "vui v·∫ª"], correct: 1, explain: "\"T·∫°i nh√† s√°ch\" l√† ƒë·ªãa ƒëi·ªÉm." },
        { id: 8, text: "ƒêi·ªÅn t·ª´ ch·ªâ ƒê·ªäA ƒêI·ªÇM: \"ƒê√™m r·∫±m, ....., ch√∫ng em ph√° c·ªó trung thu.\"", options: ["gi·ªØa s√¢n ƒë√¨nh", "ng√†y mai", "ch·ªã H·∫±ng", "m√∫a l√¢n"], correct: 0, explain: "\"Gi·ªØa s√¢n ƒë√¨nh\" l√† ƒë·ªãa ƒëi·ªÉm." },
        { id: 9, text: "Ch·ªçn t·ª´ ch·ªâ ƒê·ªäA ƒêI·ªÇM: \"Gi·ªù T·∫≠p ƒë·ªçc, ....., c√¥ gi√°o ƒëang say s∆∞a gi·∫£ng b√†i.\"", options: ["tr√™n b·ª•c gi·∫£ng", "bu·ªïi s√°ng", "quy·ªÉn v·ªü", "ngo√†i ƒë∆∞·ªùng"], correct: 0, explain: "C√¥ gi√°o gi·∫£ng b√†i \"tr√™n b·ª•c gi·∫£ng\"." },
        { id: 10, text: "Ch·ªçn CH·ª¶ NG·ªÆ th√≠ch h·ª£p: \"S√°ng s·ªõm, tr√™n ng·ªçn c√¢y, ..... h√≥t l√≠u lo.\"", options: ["con m√®o", "ch√∫ chim s·∫ª", "chi·∫øc l√°", "√¥ng m·∫∑t tr·ªùi"], correct: 1, explain: "Ch·ªâ c√≥ \"ch√∫ chim s·∫ª\" m·ªõi bi·∫øt h√≥t." },
        { id: 11, text: "ƒêi·ªÅn CH·ª¶ NG·ªÆ: \"Chi·ªÅu qua, t·∫°i b·ªÉ b∆°i, ..... ƒëang t·∫≠p b∆°i.\"", options: ["quy·ªÉn s√°ch", "b√© Lan", "c√°i b√†n", "b·∫ßu tr·ªùi"], correct: 1, explain: "\"B√© Lan\" l√† ng∆∞·ªùi c√≥ th·ªÉ t·∫≠p b∆°i." },
        { id: 12, text: "Ch·ªçn CH·ª¶ NG·ªÆ: \"M√πa xu√¢n, trong v∆∞·ªùn, ..... ƒëua nhau khoe s·∫Øc.\"", options: ["ch√∫ chim", "ƒë√†n c√°", "mu√¥n lo√†i hoa", "c√°c b·∫°n nh·ªè"], correct: 2, explain: "\"Mu√¥n lo√†i hoa\" khoe s·∫Øc." },
        { id: 13, text: "Ch·ªçn HO·∫†T ƒê·ªòNG: \"V√†o gi·ªù To√°n, trong l·ªõp, h·ªçc sinh .....\"", options: ["chƒÉm ch√∫ l√†m b√†i", "ng·ªß say s∆∞a", "ƒë√° b√≥ng", "xem tivi"], correct: 0, explain: "H·ªçc sinh \"chƒÉm ch√∫ l√†m b√†i\"." },
        { id: 14, text: "ƒêi·ªÅn HO·∫†T ƒê·ªòNG: \"S√°ng ch·ªß nh·∫≠t, ngo√†i c√¥ng vi√™n, √¥ng b√† em .....\"", options: ["ƒëang ƒëi t·∫≠p th·ªÉ d·ª•c", "ƒëang n·∫•u c∆°m", "ƒëang ng·ªß", "ƒëang h·ªçc b√†i"], correct: 0, explain: "Ra c√¥ng vi√™n \"t·∫≠p th·ªÉ d·ª•c\"." },
        { id: 15, text: "Ch·ªçn HO·∫†T ƒê·ªòNG: \"ƒê√™m giao th·ª´a, tr√™n b·∫ßu tr·ªùi, ph√°o hoa .....\"", options: ["n·ªü r·ª±c r·ª°", "ch·∫°y nh·∫£y", "h√≥t l√≠u lo", "b∆°i l·ªôi"], correct: 0, explain: "Ph√°o hoa \"n·ªü r·ª±c r·ª°\"." },
        { id: 16, text: "S·∫Øp x·∫øp ƒë√∫ng: \"ƒëang gi·∫£ng b√†i / C√¥ gi√°o / tr√™n b·ª•c gi·∫£ng / S√°ng th·ª© hai /.\"", options: ["C√¥ gi√°o ƒëang gi·∫£ng b√†i tr√™n b·ª•c gi·∫£ng S√°ng th·ª© hai.", "S√°ng th·ª© hai, tr√™n b·ª•c gi·∫£ng, C√¥ gi√°o ƒëang gi·∫£ng b√†i.", "Tr√™n b·ª•c gi·∫£ng S√°ng th·ª© hai C√¥ gi√°o ƒëang gi·∫£ng b√†i.", "S√°ng th·ª© hai C√¥ gi√°o ƒëang gi·∫£ng b√†i tr√™n b·ª•c gi·∫£ng."], correct: 1, explain: "ƒê√∫ng: TG -> ƒêƒê -> CN -> Hƒê." },
        { id: 17, text: "Th·ª© t·ª± s·∫Øp x·∫øp ƒë√∫ng l√† g√¨? (1) ngo√†i ƒë·ªìng / (2) Bu·ªïi s√°ng / (3) c√†y ru·ªông / (4) b√°c n√¥ng d√¢n", options: ["2 - 1 - 4 - 3", "4 - 3 - 2 - 1", "1 - 2 - 4 - 3", "2 - 4 - 3 - 1"], correct: 0, explain: "Bu·ªïi s√°ng (2), ngo√†i ƒë·ªìng (1), b√°c n√¥ng d√¢n (4) c√†y ru·ªông (3)." },
        { id: 18, text: "Ch·ªçn c√¢u s·∫Øp x·∫øp ƒë√∫ng: \"ƒëang ƒÉn c·ªè / ƒë√†n b√≤ / Chi·ªÅu t√† / tr√™n tri·ªÅn ƒë√™\".", options: ["Chi·ªÅu t√†, tr√™n tri·ªÅn ƒë√™, ƒë√†n b√≤ ƒëang ƒÉn c·ªè.", "ƒê√†n b√≤ ƒëang ƒÉn c·ªè tr√™n tri·ªÅn ƒë√™ chi·ªÅu t√†.", "Tr√™n tri·ªÅn ƒë√™, chi·ªÅu t√†, ƒë√†n b√≤ ƒëang ƒÉn c·ªè.", "Chi·ªÅu t√† ƒë√†n b√≤ ƒëang ƒÉn c·ªè tr√™n tri·ªÅn ƒë√™."], correct: 0, explain: "ƒê√∫ng: TG -> ƒêƒê -> CN -> Hƒê." },
        { id: 19, text: "V·ªõi t·ª´ g·ª£i √Ω \"ng∆∞·ªùi m·∫π\", c√¢u n√†o d∆∞·ªõi ƒë√¢y hay v√† ƒë√∫ng c·∫•u tr√∫c nh·∫•t?", options: ["Ng∆∞·ªùi m·∫π ƒëang n·∫•u ƒÉn trong b·∫øp t·ªëi nay.", "T·ªëi nay, trong b·∫øp, ng∆∞·ªùi m·∫π ƒëang n·∫•u b·ªØa c∆°m ngon.", "Trong b·∫øp t·ªëi nay ng∆∞·ªùi m·∫π ƒëang n·∫•u ƒÉn.", "Ng∆∞·ªùi m·∫π t·ªëi nay n·∫•u ƒÉn trong b·∫øp."], correct: 1, explain: "C√¢u B ƒë·∫ßy ƒë·ªß v√† ƒë√∫ng th·ª© t·ª±." },
        { id: 20, text: "V·ªõi g·ª£i √Ω \"b·∫ßu tr·ªùi trong xanh\", h√£y ch·ªçn c√¢u ƒë√∫ng c·∫•u tr√∫c:", options: ["M√πa thu, tr√™n cao, b·∫ßu tr·ªùi trong xanh kh√¥ng m·ªôt g·ª£n m√¢y.", "B·∫ßu tr·ªùi trong xanh v√†o m√πa thu tr√™n cao.", "Tr√™n cao m√πa thu b·∫ßu tr·ªùi trong xanh.", "B·∫ßu tr·ªùi m√πa thu tr√™n cao trong xanh."], correct: 0, explain: "C√¢u A ƒë√∫ng c·∫•u tr√∫c." }
    ];

    let timerInterval;
    let secondsElapsed = 0;
    let isSubmitting = false;

    function startTimer() {
        timerInterval = setInterval(() => {
            secondsElapsed++;
            const m = Math.floor(secondsElapsed / 60);
            const s = secondsElapsed % 60;
            document.getElementById('timerDisplay').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }

    function renderQuiz() {
        const container = document.getElementById('questions-container');
        let html = '';
        questions.forEach((q, index) => {
            html += `
                <div class="question-card">
                    <span class="question-number">C√¢u ${q.id}</span>
                    <div class="question-text">${q.text}</div>
                    <div class="options">
                        ${q.options.map((opt, i) => `<label class="option-label" id="lbl-${index}-${i}"><input type="radio" name="q${index}" value="${i}"> ${opt}</label>`).join('')}
                    </div>
                    <div class="explanation" id="explain-${index}"><strong>üí° Gi·∫£i th√≠ch:</strong> ${q.explain}</div>
                </div>`;
        });
        container.innerHTML = html;
        startTimer();
    }

    async function submitQuiz() {
        if (isSubmitting) return;

        const nameSelect = document.getElementById('studentName');
        const name = nameSelect.value;

        if (!name) {
            alert("Em ch∆∞a ch·ªçn t√™n! H√£y b·∫•m v√†o √¥ 'Ch·ªçn t√™n c·ªßa em' nh√©.");
            nameSelect.focus();
            return;
        }

        isSubmitting = true;
        stopTimer();
        
        const btn = document.getElementById('submitBtn');
        const loader = document.getElementById('btnLoader');
        const btnText = document.getElementById('btnText');
        const dbStatus = document.getElementById('db-status');
        const finalTimeStr = document.getElementById('timerDisplay').innerText;

        btn.disabled = true;
        loader.style.display = 'inline-block';
        btnText.innerText = 'ƒêANG CH·∫§M...';

        let score = 0;
        let detailResult = [];

        questions.forEach((q, index) => {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            document.getElementById(`explain-${index}`).style.display = 'block';
            
            const radios = document.getElementsByName(`q${index}`);
            radios.forEach(r => r.disabled = true);

            q.options.forEach((_, i) => document.getElementById(`lbl-${index}-${i}`).classList.remove('correct', 'incorrect'));
            
            let studentAnswer = -1;
            if (selected) {
                studentAnswer = parseInt(selected.value);
                const lbl = document.getElementById(`lbl-${index}-${studentAnswer}`);
                if (studentAnswer === q.correct) { score++; lbl.classList.add('correct'); }
                else { lbl.classList.add('incorrect'); document.getElementById(`lbl-${index}-${q.correct}`).classList.add('correct'); }
            } else {
                document.getElementById(`lbl-${index}-${q.correct}`).classList.add('correct');
            }
            detailResult.push({ cau: q.id, chon: studentAnswer, dung: q.correct });
        });

        const percentage = (score / questions.length) * 100;
        let gradeText = "";
        let gradeColor = "";
        if (percentage >= 90) { gradeText = "Xu·∫•t S·∫Øc!"; gradeColor = "#22c55e"; }
        else if (percentage >= 75) { gradeText = "Gi·ªèi Qu√°!"; gradeColor = "#3b82f6"; }
        else if (percentage >= 50) { gradeText = "Kh√° T·ªët!"; gradeColor = "#eab308"; }
        else { gradeText = "C·∫ßn C·ªë G·∫Øng!"; gradeColor = "#ef4444"; }

        document.getElementById('finalScore').innerText = `${score}/${questions.length}`;
        document.getElementById('finalGrade').innerText = gradeText;
        document.getElementById('finalGradeBadge').style.backgroundColor = gradeColor;
        document.getElementById('finalGradeBadge').innerText = `${Math.round(percentage)}%`;
        document.getElementById('timeResult').innerText = finalTimeStr;
        document.getElementById('result-overlay').style.display = 'flex';

        if (db) {
            try {
                await addDoc(collection(db, "on_tap_cau_4_thanh_phan"), {
                    ten_hoc_sinh: name,
                    diem_so: score,
                    tong_cau: questions.length,
                    thoi_gian_giay: secondsElapsed,
                    thoi_gian_lam_bai: finalTimeStr,
                    ngay_nop: serverTimestamp(),
                    chi_tiet: detailResult
                });
                dbStatus.innerHTML = "<span style='color:green; font-weight:bold'>‚úî ƒê√£ l∆∞u k·∫øt qu·∫£ th√†nh c√¥ng!</span>";
                btnText.innerText = "ƒê√É N·ªòP XONG";
            } catch (error) {
                console.error(error);
                dbStatus.innerHTML = "<span style='color:red'>L·ªói g·ª≠i b√†i.</span>";
                isSubmitting = false;
                btn.disabled = false;
                btnText.innerText = "TH·ª¨ N·ªòP L·∫†I";
            }
        }
        loader.style.display = 'none';
    }

    window.submitQuiz = submitQuiz;
    renderQuiz();
</script>

</body>
</html>
